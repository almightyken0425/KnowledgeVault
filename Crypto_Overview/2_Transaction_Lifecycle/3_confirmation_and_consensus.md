# Confirmation & Consensus 確認與共識

當礦工成功找到合法的 Nonce 後，這場競賽還沒結束。這個新區塊必須被全網接受並寫入所有人的帳本中，才算正式生效。

---

## The Protocol 協議與規則

針對你的疑問，這一切的發生，背後確實有一套絕對剛性的遊戲規則，我們稱之為 **共識協議 Consensus Protocol**。

這不是一個寫在紙上的合約，而是直接寫死在軟體程式碼中的邏輯 因為 Code is Law。所有的轉帳、挖礦、出塊，都必須嚴格符合這套協議，只要有一個 Bit 不對，就會被全網拒絕。

### 規則管轄範圍
這套協議規定了三大類事情：

- **語法規則 Syntax Rules (格式對不對):**
    - 交易的資料格式是否正確？
    - 簽章解開後是否符合數學驗證？
    - 區塊大小是否在上限內？
- **邏輯規則 Logic Rules (合不合理):**
    - 發款人的 UTXO 是否存在？
    - 轉出金額是否小於或等於餘額 (不能無中生有)？
    - 同一筆錢是否被花兩次 (雙花問題)？
- **經濟規則 Economic Rules (獎勵):**
    - 區塊獎勵是否符合當前的減半週期？
    - 手續費計算是否正確？

所有節點 (Full Nodes) 都是這個協議的執行者與裁判。

---

## Verification 驗證與傳播

發現答案的礦工會立即將該區塊廣播給全網。其他節點收到區塊後，會進行快速驗證。有趣的是，雖然算出 Nonce 耗時費力，但驗證答案是否正確卻只需要一次雜湊運算，耗時不到一毫秒。

- **全面檢查:** 節點會依照上述的 **協議規則**，逐一檢查區塊內的每一筆交易。
- **拒絕無效:** 如果區塊內包含任何一筆違反規則的交易 例如憑空印鈔，該區塊會被節點直接丟棄，礦工將拿不到任何獎勵 因小失大。

一旦驗證通過，節點就會將該區塊加到自己本地區塊鏈的尾端，並更新帳本狀態。這意味著該區塊內的所有交易已獲得第一次確認。

---

## Longest Chain Rule 最長鏈原則

如果不巧有兩位礦工在幾乎同一時間解開謎題即挖出區塊，網路就會出現短暫的分叉。一部分節點先收到區塊 A，另一部分先收到區塊 B。

這時系統如何決定誰才是正統。

- **規則:** 中本聰共識規定，節點永遠視累積工作量最大，通常也是最長的那條鏈為正確的主鏈。
- **收斂:** 隨著時間推移，下一個新區塊終究會產生。如果新區塊接在 A 後面，A 鏈就會變長。根據最長鏈原則，原本在 B 鏈上的礦工會立刻放棄 B，轉而加入 A 鏈的陣營。
- **孤塊:** 被拋棄的區塊 B 成為孤塊 Orphan Block。其中的交易若未包含在 A 鏈中，會被退回記憶體池等待重新打包。

---

## Confirmation 確認數

因此，剛被寫入最新區塊的交易並不算絕對安全，因為該區塊仍有成為孤塊的風險。

- **意義:** 每當後面多接一個新區塊，該交易就多獲得一次確認。
- **建議:** 對於大額交易，通常建議等待 6 個區塊確認 約 60 分鐘。這意味著要推翻這筆交易，攻擊者必須擁有全網一半以上的算力來重寫過去一小時的歷史，這在數學上幾乎是不可能的。
