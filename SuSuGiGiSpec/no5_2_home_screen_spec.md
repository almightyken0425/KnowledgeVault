# 首頁畫面 (HomeScreen)

_(本文件定義首頁的 UI 佈局、元件與互動邏輯 - 採用「可折疊面板」方案)_

## 核心佈局

- **頂部 Header (固定):**
    
    - **位置:** 始終固定在螢幕頂部，不隨任何內容滾動而隱藏。
        
    - **內容:**
        
        - **App 名稱 (或 Logo):** 位於頂部中央。
            
        - **左側按鈕區:** 包含**一個** `報表篩選按鈕` (例如 "篩選" 或 "調整" 的圖示)。
            
        - **右側按鈕區:** 包含 `設定入口按鈕` (例如齒輪圖標) 和一個 `(未來) 搜尋按鈕` 的預留位置。
            
- **主內容區 (View):**
    
    - **位置:** 位於頂部 Header 下方，佔據所有剩餘空間。
        
    - **結構:** 此區塊本身**不可**垂直滾動。它在內部垂直劃分為以下區域：
        
        - **圓餅圖區塊 (PieChart):** 位於上方，預設可見，佔據一定初始高度。

        - **總餘額與控制區塊:** 位於圖表下方，顯示總餘額，並包含列表分組切換按鈕。

        - **逐筆紀錄區塊:** 位於最下方，佔據剩餘高度，此區域**內部可垂直滾動**。

- **底部 Footer (固定):**
    - **位置:** 固定在螢幕底部。
    - **內容:** 包含三個核心操作按鈕，由左至右排列：
        - **新增收入按鈕 (+):** 點擊後觸發「核心功能鎖」檢查。
        - **新增轉帳按鈕 (→):** 點擊後觸發「核心功能鎖」檢查。
        - **新增支出按鈕 (-):** 點擊後觸發「核心功能鎖」檢查。
    - **核心功能鎖邏輯 (Footer 點擊時):**
        - **1. 檢查 Premium:** 點擊任一新增按鈕時，App 必須立即檢查「**本機狀態 (e.g., PremiumContext)**」中的 `isPremiumUser`。
        - **2. 付費版流程:** 若 `isPremiumUser` 為 `true`，立即導航至對應的編輯器畫面（`TransactionEditorScreen` 或 `TransferEditorScreen`）。
        - **3. 免費版檢查:** 若 `isPremiumUser` 為 `false`，**不得立即導航**，改為執行「有效項目計數」查詢。
        - **4. 計數查詢:** App 查詢「**本機資料庫 (Local DB)**」，計算：
            - `active_account_count` = `Accounts` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
            - `active_category_count` = `Categories` 表中 `deletedOn` 為 `null` 且 `disabledOn` 為 `null` 的紀錄總數。
        - **5. 判斷:**
            - **若 `active_account_count <= 3` 且 `active_category_count <= 10` (符合免費版限制):** 允許導航至對應的編輯器畫面。
            - **若 `active_account_count > 3` 或 `active_category_count > 10` (超出免費版限制):** **阻擋導航**。
        - **6. 阻擋 UI:** 阻擋導航時，應彈出一個提示對話框，說明已超出免費版限制，並提供「前往設定」（停用項目）或「立即升級」（導航至 `PaywallScreen`）的選項。


## 主內容區元件詳述

_(此區域的元件會根據動畫互動進行高度調整)_

- **圓餅圖區塊 (`PieChart`):**
    
    - **圓餅圖 (甜甜圈圖):**
        
        - **數據:** 視覺化顯示**當前時間區間**內、**所選帳戶**的、按**使用者自訂類別** (`categoryId`) 聚合的支出分佈。
            
        - **貨幣顯示邏輯:**
            - 若所有選定的帳戶都使用**相同的貨幣**，則總支出以該貨幣顯示。否則 (即選定的帳戶包含多種貨幣)，總支出將**換算為基礎貨幣**顯示。

    - **類別摘要 (可滾動):**
        
        - **UI:** 一個**水平滾動區域 (Horizontal ScrollView)**。
            
        - **數據:** 顯示**所有**在當前時間區間內有支出的自訂類別（按金額或佔比降冪排列）。
            
        - **項目內容:** 顏色標示 (與圓餅圖對應)、類別名稱 (`defaultName`)、總金額或佔比。
            
        - **互動 (滾動):** 使用者可以左右滑動瀏覽所有類別。
                        
- **總餘額與控制區塊:**
    
    - **位置:** 位於**圓餅圖區塊**和**逐筆紀錄區塊**之間。
    
    - **內容 (總餘額):** 顯示當前時間區間內、所選帳戶的**總收入**、**總支出**、**總結餘**。
        - **貨幣顯示邏輯:**
            - 若所有選定的帳戶都使用**相同的貨幣**，則總餘額以該貨幣顯示。
            - 否則 (即選定的帳戶包含多種貨幣)，總餘額將**換算為基礎貨幣**顯示。

        - **計算註記:** 此處的「總收入」與「總支出」計算**必須包含** `Transfer` 記錄。若轉帳的轉出/轉入方在所選帳戶範圍內，應被視為支出/收入，以正確反映所選帳戶範圍的現金流變化。
        
    - **互動 (列表控制):** 包含**分組模式切換按鈕** (例如 `calendar` / `grid` 圖標)，允許使用者在「按日期分組」和「按類別分組」之間切換下方**逐筆紀錄區塊**的顯示模式。

- **逐筆紀錄區塊 (`FlatList`):**
    
    - **UI:** 預設佔據螢幕下方一定高度，內部可垂直滾動。
    
    - **數據:** 從「**本機資料庫 (Local DB)**」查詢**當前時間區間**內、**所選帳戶**的交易紀錄 (`Transactions` 和 `Transfers`)，按 `transactionDate` 降冪排列。
    - **排序邏輯:** 查詢結果應按 `transactionDate` **降冪**排列，若日期相同，則再按 `updatedOn` **降冪**排列，以確保最新編輯的紀錄會顯示在最上方。
        
    - **顯示模式 (可切換):** 根據上方**總餘額與控制區塊**中切換按鈕的狀態顯示：
        
        - **按日期分組模式:** 預設模式，類似一般交易流水，可顯示日期分隔線。
            
        - **按類別分組模式:** 將交易按 `categoryId` 匯總，顯示各類別總金額，並可點擊展開查看該類別下的交易明細。

    - **顯示內容 (每筆交易):**
        
        - 圖標、類別名稱、(可選) 帳戶名稱、(可選) 備註、金額 (原始幣別)。
        - **監聽變更 (Real-time Update):** 此列表應即時監聽「本機資料庫」的變更。當背景同步或定期交易任務寫入新資料時，UI 應自動刷新。
            
    - **互動 (點擊):**
        
        - **點擊單筆紀錄:** 導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` (包含**管理**定期交易的入口)。


## 核心互動

- **動畫互動 (折疊/展開):** 
    
    - **向上滾動 (展開列表):** 當使用者在**逐筆紀錄區塊**中向上滾動時，**圓餅圖區塊**動畫收合 (例如高度變為 0 或向上滑出螢幕)。**逐筆紀錄區塊**動畫展開以填滿空間，**總餘額與控制區塊**保持可見。
        
    - **向下滾動 (恢復圖表):** 當使用者在 (已展開的)**逐筆紀錄區塊**中向下滾動至列表頂部 (scroll offset 0) 時，觸發反向動畫，**圓餅圖區塊**恢復顯示，**逐筆紀錄區塊**縮回原高度。
        
- **時間區間切換 (左右滑動手勢):**
    
    - **適用範圍:** `daily`, `weekly`, `monthly`, `yearly` 時間粒度 (由 Header 中按鈕設定)。
        
    - **行為:** 僅允許由當前期間向左（查看過去）滑動；嘗試往右進入今天以後的期間時需鎖定頁面並以 Toast/Banner 提示「不可瀏覽未來」，遵循 `no0_pending_discussion.md`。
        
    - **資料更新:** 允許的滑動操作會重新觸發**「本機資料庫」**的查詢，並更新**圓餅圖區塊**、**總餘額與控制區塊**以及**逐筆紀錄區塊**的數據並觸發動畫。
        
- **報表篩選 Modal (Header 互動):**
    - **觸發:** 使用者點擊 Header 左側的 `報表篩選按鈕`。
    - **UI:** 彈出一個**底部彈出式 Modal (Bottom Sheet)**。
    - **Modal 內部佈局:**
        - **Modal 頂部導航列:**
            - **元件:** 一個位於 Modal 頂部的標題列。
            - **左側:** 「取消」按鈕（點擊後關閉 Modal，不儲存變更）。
            - **中間:** 標題「篩選報表」。
            - **右側:** 「完成」按鈕 (Done)。
            - **「完成」按鈕邏輯:** 點擊後，Modal 關閉，`HomeScreen` 根據 Modal 內選定的「時間粒度」和「帳戶選項」，重新觸發**「本機資料庫」**的查詢，並更新主內容區的所有數據。
        - **時間粒度區 (Time Granularity) (位於導航列下方):**
            - **元件:** 一個分段控制項 (Segmented Control)。
            - **選項:** "日", "週", "月", "年", "全部"。
            - **邏輯:** 這是單選。
        - **帳戶篩選區 (Account Filter):**
            - **元件:** 一個可滾動的多選列表 (Checkbox list)，包含「全選」選項。
            - **邏輯 (遵循先前結論):** 此列表**必須**排除所有 `deletedOn` 或 `disabledOn` **非 `null`** 的帳戶。
            - **限制 (遵循先前結論):** 此列表**不受**免費版 3 個帳戶的數量限制。
    - **預設行為:**
        - App 啟動時，時間粒度預設為「當日 (daily)」。
        - 帳戶篩選器預設僅選取 `sortOrder` 最高的帳戶（即 `sortOrder` 最小的項目）。
    - **未來限制:**
        - Modal 內的日期/粒度控制不可跳到今天以後；若使用者嘗試選擇未來期間，需拒絕操作並提示原因。

- **導航邏輯 (Navigation Logic):**
    - 當使用者點擊 Footer 中的新增支出/收入/轉帳按鈕時：
        - **如果**當前 `HomeScreen` 的時間粒度為 `daily`，則導航至 `TransactionEditorScreen` 或 `TransferEditorScreen` 時，需傳入當前報表日期作為 `defaultDate` 參數。
        - **否則**，正常導航，不傳遞日期參數。
