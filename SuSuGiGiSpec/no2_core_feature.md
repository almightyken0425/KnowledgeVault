# 2. 核心功能

_(本文件定義 App 的主要功能邏輯與規格)_

## 1. 資料流 (Data Flow) - 基礎

- **新增交易/轉帳後:**
    
    1. 資料儲存 (本地 DB / 同步至 Firestore)。
        
    2. 觸發狀態更新 (例如：更新 Redux/Zustand store 或 Context)。
        
    3. App 導航返回首頁 (`HomeScreen`)。
        
    4. `HomeScreen` 偵測到相關狀態變動 (透過 selector 或 context consumer)，重新觸發 `useMemo` 計算。
        
    5. 重新計算當前報表設定下的總計、圖表數據、近期列表數據。
        
    6. UI 重新渲染，顯示最新狀態。
        

## 2. 多幣別處理 (Multi-Currency) - _[付費功能]_

- **預設/基礎貨幣 (Base Currency):**
    
    - **初始化:** 依裝置地區設定預設 (免費版僅能使用此貨幣)。
        
    - **使用者設定:** 可在「設定」中更改 (免費版僅能更改，不能新增)。
        
- **帳戶建立流程 (付費版):**
    
    - 當使用者建立一個**非基礎貨幣**的帳戶時，**必須**提示使用者輸入**當前**該貨幣對基礎貨幣的匯率 (例如 "1 USD = ? TWD")。
        
    - **需明確告知使用者：** "此匯率將用於未來報表換算。報表計算時，將**一律採用您為該貨幣對輸入的最新一筆匯率記錄**。"
        
    - 將使用者輸入的初始匯率存入 `CurrencyRates`，`RateDate` 設為當前日期 (UTC Unix Timestamp ms，建議為該日 00:00:00 UTC)。
        
- **報表顯示邏輯:**
    
    - **目標:** 首頁總計和圖表以**基礎貨幣**顯示匯總金額。
        
    - **計算方式 (細化):**
        
        1. **確定篩選條件:** 根據使用者在首頁選擇的時間粒度、具體時間區間 (基於使用者設定時區計算 UTC 範圍)，以及納入統計的帳戶列表 (由 `homescreen_spec.md` 中的「帳戶篩選器」決定)。
            
        2. **遍歷記錄:** 程式迭代處理**所有**使用者的 `Transactions` 和 `Transfers` 列表/表格 (通常指本地快取/DB 中的數據)。
            
        3. **條件篩選:** 對於每一筆記錄，執行以下檢查：
            
            - **時間符合:** `TransactionDate` (UTC ms) 是否落在選定的 UTC 時間範圍內？
                
            - **帳戶符合:** `AccountId` (或 `AccountFromId`/`AccountToId`) 是否在選定的帳戶列表中？
                
            - **未刪除:** `DeletedOn` 是否為 `null`？
                
        4. **納入計算的記錄:** 只有**同時滿足**上述所有條件的記錄，才進入下一步的價值計算。
            
        5. **價值計算 (換算為基礎貨幣):**
            
            - **判斷記錄類型:** 檢查該筆記錄是 `Transaction` 還是 `Transfer`。
                
            - **若是「轉帳 (Transfer)」:**
                - **情境:** 處理帳戶間的資金移動。
                - **計算邏輯:** 在計算「收支結餘」時，**應忽略 `Transfer` 記錄**。因為轉帳是內部資金流動，其對總資產的影響為零（或僅為手續費/匯差損失），而它的 `AmountFromCents` 和 `AmountToCents` 已經反映在各帳戶的餘額中。報表聚合的是**外部**的收支行為。
                
            - **若是「收支 (Transaction)」:**
                - **情境:** 處理對外的收入或支出。
                - **計算邏輯 (針對非基礎貨幣交易 -** _**[付費功能]**_**):**
                    - 取得交易帳戶的貨幣ID (`fromCurrencyId`) 和基礎貨幣ID (`baseCurrencyId`)。
                    - 在 `CurrencyRates` 中查找符合 `UserId`, `CurrencyFromId` = `fromCurrencyId`, `CurrencyToId` = `baseCurrencyId`, `DeletedOn` is `NULL` 的匯率記錄。
                    - 按 `RateDate` **降冪排列 (DESC)**，選取**最新的一筆**匯率 (`LIMIT 1`)。
                    - 使用此最新匯率 (`latestRate.RateCents`) 將 `tx.AmountCents` 換算成基礎貨幣的 Cents 值。
                
        6. **金額加總:** 將所有基礎貨幣交易的金額，以及經過換算的非基礎貨幣交易金額（均以基礎貨幣的 Cents 表示），根據其 `CategoryType` 分別加總。
            
        7. **計算結餘:** 總收入 - 總支出。
            
- **逐筆紀錄列表顯示:**
    
    - 金額顯示原始幣別及符號。
        
    - (可選) 顯示換算後的基礎貨幣金額。
        

## 3. 報表功能 (Report)

- **主要報表 (首頁):**
    
    - 預設為首頁的儀表板卡片 (摘要視圖) 中的甜甜圈圖。
        
    - **預設顯示:** App 打開時，儀表板應顯示使用者標示為 `IsPrimary=true` 的帳戶的匯總數據，時間粒度預設為當日 (`daily`) (基於使用者設定時區)。
        
    - 數據內容與互動如 `5.2. 首頁畫面規格.md` 規格所述。
        
- **進階報表 -** _**[付費功能]**_**:** (未來考量) 更詳細的報表頁面。
    

## 4. 使用者認證與同步 (Auth & Sync) - _[免費核心]_

- **登入方式:** **強制 Google 快速登入**，Email 作為 `UserId`。 (已移除 Apple 登入以簡化帳號連結問題)。
    
- **資料同步:** 使用 **Firebase Firestore** 作為後端資料庫，實現即時同步與「無痛換機」的資料轉移。
    
    - **Firestore 成本:** 初期用量預計在 Spark Plan 免費額度內。
        
    - **同步失敗處理:** Firestore SDK 內建離線支援。App 優先讀寫本地快取，SDK 會在網路恢復時自動重試同步。使用者在離線時應能無縫操作，無需顯示頻繁的錯誤提示 (僅在首次登入或重大失敗時提示)。
        
- **首次登入流程:**
    
    1. App 啟動 -> 導向登入畫面 (`5.1`)。
        
    2. Google 登入成功，取得 `UserId` (Email)。
        
    3. **查找雲端資料:** 檢查 Firestore 是否存在該 `UserId` 的資料。
        
    4. **若無資料 (新用戶):**
        
        - 依裝置地區設定預設「基礎貨幣」、「時區」並存入 `Settings`。
            
        - 建立預設的「主要帳戶」(`IsPrimary: true`) 並存入 `Accounts` (數量需符合免費版限制)。
            
        - 建立預設的 `Categories` (共 10 個，包含在免費版限制內):
                - **支出 (7):** 餐飲、交通、居住、購物、娛樂、帳單、健康。
                - **收入 (3):** 薪水、投資、兼職。
            
        - 上傳這些初始資料到 Firestore。
            
    5. **若有資料 (舊用戶):**
        
        - 從 Firestore 下載同步資料到 App 本地快取/DB。
            
    6. 導航至首頁 (`5.2`)。
        
#### 4.1. 多裝置同步策略 (Multi-Device Sync Strategy)

-   **策略:** App **支援**使用者在多個裝置上同時登入（例如手機、平板），不採用強制單一裝置登出的機制，以提供無縫的跨裝置體驗。
-   **理由:**
    -   **使用者體驗:** 強制登出會在使用多裝置的現代情境下，造成嚴重的操作摩擦。
    -   **離線情境:** 強制單一裝置登入無法解決「離線操作後，重新連網」所引發的資料狀態不一致問題。
-   **技術實現:** 為了支援穩健的多裝置同步，核心資料表（如 `CurrencyRates`）採用「只增不改 (Append-Only)」的日誌模式。這從根本上避免了因 `UPDATE` 操作在不同裝置間可能引發的「競爭條件 (Race Condition)」，簡化了同步邏輯。


## 5. AI 分析整合 (Future Feature) - _[付費功能]_

- **定位:** 非 MVP 功能。
    
- **觸發點:** 設定開關 或 首頁健檢按鈕。
    
- **使用者同意:** 強制要求。
    
- **互動方式:** Modal 視窗。
    
- **資料欄位:** 現有欄位足夠，無需預留。
    
- **需後續評估:** 價值、成本、付費意願。
    

## 6. 設定功能 (Settings)

- **第一層入口:** 類別管理, 帳戶管理, 匯率管理 (_[付費功能]_), 偏好設定。
    
- **偏好設定 (第二層):**
    
    - **語系 (Language):** 切換顯示語言。
        
    - **主要貨幣 (Base Currency):** 設定基礎貨幣。
        
    - **時區 (Time Zone):**
        
        - **功能:** 設定用於日期計算和顯示的**「主要時區」** (預設自動偵測裝置時區，儲存 IANA ID)。
            
        - **應用 (重要):**
            
            1. **顯示:** App 內所有顯示的日期時間，均應使用此「主要時區」來格式化 UTC 時間戳記。
                
            2. **計算:** 所有報表（日/週/月）的時間邊界（00:00 - 23:59）均應以此「主要時區」為準進行計算。
                
            3. **定期交易:** `lastRecurringCheckDate` 的檢查應基於此「主要時區」的「今天」日期。
                
        - **出國情境:**
            
            1. **查看資料:** App **忽略**裝置當前的旅行時區，**始終**使用「主要時區」顯示，確保報表和歷史記錄一致性。
                
            2. **新增資料:** 新增交易時，日期選擇器預設為裝置當下的本地時間（例如 'Asia/Tokyo 11:00'）。儲存時，App 將此時間轉換為 **UTC 時間戳記** (e.g., 02:00 UTC) 存入 `TransactionDate`。查看時，此 02:00 UTC 會被「主要時區」('Asia/Taipei') 格式化為 '10:00'。
                
    - **匯出資料 (Export Data) -** _**[付費功能]**_**:**
        
        - **說明:** 提供**本地端**資料匯出功能，不涉及 Firestore 匯出。
            
        - **格式:**
            
            - `.db`: 匯出 App 本地資料庫檔案 (若使用 SQLite 等)。
                
            - `.csv`: 僅匯出 `Transactions` 資訊，供使用者在 Excel/Google Sheet 中分析。
                
    - **清除資料 (Clear Data):**
        
        - **清除本地快取:** 清除 App 在本地裝置上的所有快取/資料 (用於 Debug 或重置，重啟後會從 Firestore 重新同步)。
            
        - **(可選) 清除雲端資料:** 提供一個更危險的選項，允許使用者清除其在 Firestore 上的所有雲端數據 (需再次驗證身分)。
            

## 7. 其他核心功能

### 7.1. 定期交易 (Recurring Transactions) - _[付費功能]_

- **設定入口:** 新增/編輯 交易/轉帳 頁面，設定頻率、起訖日。
    
- **建立邏輯:**
    - 當使用者在 `TransactionEditorScreen` 中設定並儲存一個新的定期交易時：
        1.  在 `Schedules` 表中建立一筆新的排程記錄。
        2.  **立即**為該排程的 `StartOn` 日期產生第一筆交易實例 (`Transaction` 或 `Transfer`)。

- **資料儲存 (`Schedules` Table):**
    
    - 直接儲存模板信息 (包含 `IsTransfer`, `TemplateAmountCents/From/To`, `TemplateCategoryId`, `TemplateAccountId/From/To`, `TemplateNote`)。
        
- **補產生邏輯 (App 啟動時檢查):**
    
    1. 本地記錄 `lastRecurringCheckDate` (日期，基於使用者「主要時區」)。
        
    2. 若 `currentDateInUserTZ` (使用者「主要時區」的今天) > `lastRecurringCheckDate`，則執行。
        
    3. 遍歷有效 `Schedules`。
        
    4. 計算 `lastRecurringCheckDate` (不含) 到 `currentDateInUserTZ` (含) 間應產生的日期 (`instanceDate` - 指該時區的日期，但儲存用 UTC ms)。
        
    5. **檢查重複 (簡化 - "存在即跳過"):**
        
        - 檢查 `Transactions`/`Transfers` 表是否已存在 (**不論 `DeletedOn` 狀態**) `ScheduleId` + `ScheduleInstanceDate` = `instanceDate` (對應的 UTC ms) 的記錄。
            
    6. **產生交易:**
        
        - **若不存在:** 使用 `Schedule` 模板創建新記錄 (包含 `ScheduleId`、`ScheduleInstanceDate`，且 `TransactionDate` 設為 `instanceDate` 對應的 UTC ms)。
            
        - **若已存在:** **跳過**，不執行任何操作。
            
    7. 更新 `lastRecurringCheckDate` 為 `currentDateInUserTZ` 對應的日期標記。
        
- **編輯/刪除行為:** 當使用者對一筆由定期交易所產生的交易 (`ScheduleInstanceDate` 非空) 操作時：
    
    1. 彈出選項: **「僅此一筆」** / **「此筆及未來所有」**。
        
    2. **「僅此一筆」編輯:** 直接修改該筆 `Transaction` / `Transfer` 記錄（使用者可修改 `TransactionDate`, `AmountCents` 等）。App 的生成邏輯 (步驟 5) 會因為記錄已存在而自動跳過，保留使用者的修改。
        
    3. **「僅此一筆」刪除:** 直接軟刪除 (設定 `DeletedOn`) 該筆 `Transaction` / `Transfer` 記錄。App 的生成邏輯會因為記錄已存在 (雖然被軟刪除) 而自動跳過，使其保持刪除狀態。
        
    4. **「此筆及未來所有」編輯:**
        
        - 將原 `Schedule` 的 `EndOn` 設為此交易日期的前一個週期日期 (例如，月繳的 10/15 號交易，`EndOn` 設為 10/14 號)。
            
        - 根據新內容創建一個**新的 `Schedule`**，`StartOn` 為此交易日期 (`TransactionDate` 或 `ScheduleInstanceDate`)。
            
        - **不修改**任何歷史 `Transaction` / `Transfer` 記錄。
            
    5. **「此筆及未來所有」刪除:**
        
        - 將原 `Schedule` 的 `EndOn` 設為此交易日期的前一個週期日期。
            
        - **不修改**任何歷史 `Transaction` / `Transfer` 記錄。
            

### 7.2. 搜尋交易 (Search)

- **邏輯:** 僅搜尋 `Transaction` / `Transfer` 表中的 `Note` 欄位關鍵字。
    

### 7.3. 匯入資料 (Import)

- **(待細化)** CSV 匯入交易。
    

### 7.4. 快速捕捉小工具 (Widgets)

- **MVP:** 提供一個「**新增支出**」桌面小工具按鈕。
    
- **行為:** 點擊按鈕應 **Deep Link** 直接開啟 App 並顯示「新增支出」表單。
    
- **預設值:** 表單的預設值（如帳戶、類別）應遵循 App 內點擊「新增支出」按鈕的相同邏輯（待 `記帳頁面` 規格細化）。
    
- **未來考量:** 提供可配置的小工具 (例如 2x1 顯示支出/收入按鈕)。
    

## 8. 版本區隔 (Monetization)

- **策略說明:** 初期採用功能限制型免費增值 (Freemium) 模式，**不導入廣告**。此策略基於以下考量：
    
    - **專注核心轉換:** 免費版限制 (3 帳戶 / 10 類別 / 無多幣別 / 無定期交易) 已構成強大的功能牆 (Paywall)，應足以驅動核心使用者轉換。
        
    - **避免干擾與流失:** 避免廣告提高「免費使用者流失率」，確保使用者有足夠時間體驗 App 核心價值並撞到功能牆。
        
    - **維護品牌信任:** 記帳 App 處理敏感財務數據，「免費且安全 (Firestore 同步)」是核心價值，不加入廣告可強化此信任感，避免因廣告 SDK 帶來的隱私顧慮而降低「下載轉換率」。
        
    - **避免營收同類相食:** 避免「移除廣告」這個低價值付費理由，稀釋了「多幣別」和「定期交易」等高價值功能的 ARPPU (每付費使用者平均收入)。
        
    - **未來彈性:** 此策略可在上線後根據實際轉換率數據進行調整。
        
- **免費版 (Free Tier):**
    
    - **核心功能:** 完整的新增/編輯/刪除交易 (收支/轉帳)。
        
    - **帳戶與類別:** 
        - 限制自訂帳戶**最多 3 個**。
        - 限制自訂類別**最多 10 個**。此上限包含首次登入時建立的預設種類，但不包含使用者已刪除 (`DeletedOn = true`) 的種類。
        
    - **報表:** 僅提供首頁儀表板，報表篩選功能 (如帳戶選擇、時間粒度) 完整提供。
        
    - **認證與同步:** 包含 Google 登入與 Firestore 雲端同步 (核心價值)。
        
    - **幣別:** **不支援**多幣別功能，僅限使用單一基礎貨幣。
        
    - **自動化:** **不支援**定期交易 (`Schedules`) 功能。
        
- **付費版 (Premium Tier):**
    
    - **無限制:** 無限制的自訂帳戶與類別數量。
        
    - **多幣別功能:** 完整的多幣別帳戶 (2.2)、跨幣別轉帳、手動匯率管理 (2.6)。
        
    - **自動化:** 完整的定期交易 (`Schedules`) 功能 (2.7)。
        
    - **進階報表與資料:**
        
        - (未來) 專屬的詳細報表頁面。
            
        - 匯出資料 (`.csv`, `.db`) 功能 (2.6)。
            
    - **客製化:** (未來) 更多 App 圖標、顏色主題。
        
    - **AI 分析:** (未來) AI 財務健檢功能 (2.5)。
